<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Stats Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .stat-item { margin-bottom: 10px; font-size: 1.2em; }
        #status { margin-top: 20px; color: grey; }
    </style>
</head>
<body>
    <h1>Live Statistics</h1>
    <div id="statsContainer">
        <div class="stat-item">Count IN: <span id="countIn">N/A</span></div>
        <div class="stat-item">Count OUT: <span id="countOut">N/A</span></div>
        <div class="stat-item">Face Count: <span id="faceCount">N/A</span></div>
        <div class="stat-item">Daily Event Count: <span id="dailyEventCount">N/A</span></div>
        <div class="stat-item">Event Active: <span id="eventActive">N/A</span></div>
        <div class="stat-item">Current Event Count IN: <span id="currentEventCountIn">N/A</span></div>
    </div>
    <div id="lastUpdate">Last update: N/A</div>
    <div id="status">Connecting...</div>

    <script>
        const countInEl = document.getElementById('countIn');
        const countOutEl = document.getElementById('countOut');
        const faceCountEl = document.getElementById('faceCount');
        const dailyEventCountEl = document.getElementById('dailyEventCount');
        const eventActiveEl = document.getElementById('eventActive');
        const currentEventCountInEl = document.getElementById('currentEventCountIn');
        
        const lastUpdateEl = document.getElementById('lastUpdate');
        const statusDiv = document.getElementById('status');
        const wsUrl = 'ws://localhost:8765';
        let ws;

        function connect() {
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                statusDiv.textContent = 'Connected to WebSocket server.';
                console.log('WebSocket connection established');
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    if (message.type === 'stats' && message.data) {
                        const stats = message.data;
                        countInEl.textContent = stats.count_in;
                        countOutEl.textContent = stats.count_out;
                        faceCountEl.textContent = stats.face_count;
                        dailyEventCountEl.textContent = stats.daily_event_count;
                        eventActiveEl.textContent = stats.event_active ? 'Yes' : 'No';
                        currentEventCountInEl.textContent = stats.current_event_count_in;
                        lastUpdateEl.textContent = `Last update: ${message.timestamp}`;
                    }
                } catch (e) {
                    console.error('Error processing message or invalid JSON:', e, event.data);
                    statusDiv.textContent = 'Error processing stats message.';
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket Error:', error);
                statusDiv.textContent = 'WebSocket error. Check console.';
            };

            ws.onclose = (event) => {
                statusDiv.textContent = `WebSocket closed: ${event.reason || 'No reason specified'}. Attempting to reconnect in 3 seconds...`;
                console.log('WebSocket connection closed. Code:', event.code, 'Reason:', event.reason);
                setTimeout(connect, 3000);
            };
        }
        connect();
    </script>
</body>
</html>